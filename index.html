<!DOCTYPE html>
<html>
	<head>
    	<meta name="robots" content="all">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>链式反应</title>
		<meta name="mobile-agent" content="format=html5;url=http://ccx01.com">
		<meta name="applicable-device" content="mobile">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no">
		<meta name ="keywords" content="Sign,ccx01,sign,the day of sign,signXday,沙因,游戏,银河,宇宙,时间,链式反应">
		<meta name="description" content="链式反应,计划通,链式问答具象化">
		<style>
			body {
				margin: 0;
				padding: 0;
			}
			.node {
				overflow: hidden;
				margin: 20px 10px;
				border: 1px solid #ccc;
				border-radius: 4px;
				box-shadow: 0 3px 1px #ccc;
			}
			.node .main,
			.node .scene {
				padding: 15px 10px;
				cursor: pointer;
			}
			.node .action {
				overflow: hidden;
				float: left;
			}
			.node .action .option,
			.node .add {
				float: left;
				border: 1px solid #ddd;
				padding: 10px;
				border-radius: 4px;
				margin: 0 0 10px 10px;
				cursor: pointer;
			}
			.add {
				display: inline-block;
				border-radius: 5px;
				margin: 20px 10px;
				padding: 10px;
				border: 1px solid #ccc;
				border-radius: 4px;
				cursor: pointer;
			}
			.left {
				position: fixed;
				top: 0;
				left: 0;
				width: 20%;
				height: 100%;
				overflow: auto;
				background: #363636;
			}
			.trace {
				padding: 0;
				margin: 0;
			}
			.trace li {
				cursor: pointer;
			}
			.trace .active {
				background: #9add73;
				box-shadow: 0 2px 1px #999;
			}
			.trace b {
				display: none;
			}
			.page {
				position: absolute;
				top: 0;
				left: 22%;
				width: 75%;
			}
			.tpl {
				display: none;
			}
			.box {
				padding: 20px;
				border: 1px solid #ccc;
				border-radius: 5px;
				margin: 20px 10px;
				background: #fefefe;
				box-shadow: 0 5px 1px #999;
			}
			.expand {
				width: 30px;
				height: 60px;
				line-height: 60px;
				font-size: 60px;
				color: #fff;
				background: #363636;
				position: fixed;
				bottom: 20px;
				left: 20%;
				cursor: pointer;
			}

			.popup {
				position: fixed;
				width: 100%;
				height: 100%;
				background: rgba(0,0,0,.2);
			}
			.popup .box {
				width: 50%;
				margin: 10% 25%;
				position: relative;
			}
			.box textarea {
				display: block;
				margin: 10px 0;
				width: 90%;
				height: 70px;
			}
			#add-btn {
				display: inline-block;
				border: 1px solid #aaa;
				padding: 5px;
				box-shadow: 1px 1px 1px #ccc;
				cursor: pointer;
			}
			.ex .left {
				width: 75%;
			}
			.ex .page {
				left: 77%;
				width: 20%;
			}
			.ex .expand {
				left: 75%;
			}
			.user {
				width: 100px;
				height: 100px;
				border-radius: 50%;
				box-shadow: 0 0 6px #aaa;
				background: #fff;
				position: fixed;
				bottom: 20px;
				right: 20px;
			}
			@media screen and (max-width: 640px){
				.trace span {
					display: none;
				}
				.trace b {
					display: block;
				}
				.expand {
					width: 15px;
					height: 30px;
					line-height: 30px;
					font-size: 30px;
				}
				.user {
					width: 30px;
					height: 30px;
				}
				.ex .trace span {
					display: block;
				}
				.ex .trace b {
					display: none;
				}
				.ex .node {
					white-space: nowrap;
				}
				.ex .action,
				.ex .add {
					display: none;
				}
			}
		</style>
	</head>
	<body>
		<div class="left">
			<div class="box" onclick="getMainPage();">首页</div>
			<ul class="trace"></ul>
		</div>
		<div class="page"></div>
		<div class="expand">></div>
		<div class="user" onclick="alert('用户登录(未完成)');"></div>
		<!-- template -->
		<div class="popup tpl">
			<div class="box">
				<p class="tip"></p>
				<textarea id="add" type="text"></textarea>
				<p class="length"></p>
				<span id="add-btn">添加</span>
			</div>
		</div>
		<div class="user tpl">
			<div class="box">

			</div>
		</div>
		<!-- id cont tag time -->
		<template id="main-tpl" class="tpl">
			<div class="node">
				<div class="main" data-mid="{#id}" data-aid="0">{#cont}</div>
			</div>
		</template>
		<template id="add-main-tpl" class="tpl">
			<span class="add" data-type="main">添加主题</span>
		</template>
		<!-- id mid aid cont time -->
		<template id="scene-tpl" class="tpl">
			<div class="node">
				<div class="scene" data-sid="{#id}" data-mid="{#mid}">{#cont}</div>
				<div id="s{#id}" class="action"></div>
			</div>
		</template>
		<template id="add-scene-tpl" class="tpl">
			<span class="add" data-type="scene" data-aid="{#aid}" data-mid="{#mid}">添加场景</span>
		</template>
		<!-- id sid cont time -->
		<template id="action-tpl" class="tpl">
			<span id="a{#id}" class="option" data-aid="{#id}">{#cont}</span>
		</template>
		<template id="add-action-tpl" class="tpl">
			<span class="add" data-type="action" data-id="{#id}">+</span>
		</template>
		<template id="trace-tpl" class="tpl">
			<li class="box{#active}" onclick="getTrace({#aid},{#mid},{#pos})"><b>{#pos}</b><span>{#cont}</span></li>
		</template>
		<!-- template -->
		<script>
			/* ajax */
			function ajax(url, data, callback) {
				var xmlhttp = new XMLHttpRequest();
					xmlhttp.open("POST", url, true);
					xmlhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
					xmlhttp.send(data);
					callback = callback || function() {};
				xmlhttp.onreadystatechange = function() {
					if(xmlhttp.readyState == 4 && xmlhttp.status == 200) {
						callback(JSON.parse(xmlhttp.responseText));
					}
				}
			}
			/* ajax */

			/* dom control */
			var $add = document.querySelector("#add");
			var $add_btn = document.querySelector("#add-btn");
			var $popup = document.querySelector(".popup");
			var $popup_tip = $popup.querySelector(".tip");
			var $popup_len = $popup.querySelector(".length");
			var $page = document.querySelector(".page");
			$page.addEventListener("click", getPage);

			function getPage(e) {
				if(document.body.className == "ex") {
					document.body.className = "";
					return;
				}
				var t = e.target;
				var d = t.dataset;
				switch(t.className) {
					case "main":
						// mainToScene(d.aid, d.mid, t.innerHTML);
						getScene(d.aid, d.mid, t.innerHTML, 0);
					break;
					case "scene":
						getAction(d.sid, t.innerHTML);
					break;
					case "option":
						var $scene = t.parentNode.parentNode.querySelector(".scene");
						getScene(d.aid, $scene.dataset.mid, $scene.innerHTML + "(" + t.innerHTML + ")", $scene.dataset.sid);
					break;
					case "add":
						popup(t);
					break;
				}
			}

			HTMLElement.prototype.appendNodes = function(nodes) {
				var fragment = document.createDocumentFragment();
				for(var i = 0; i < nodes.length; i++) {
					fragment.appendChild(nodes[i].cloneNode(true));
				}
				this.appendChild(fragment);
			}
			function genNode(html) {
				var div_tmp = document.createElement("div");
					div_tmp.innerHTML = html;
				var nodes = div_tmp.childNodes; 
				return nodes;
			}
			function tplEngine(tpl, data) {
				var re = /{#(\w+)?}/;
				while (match = re.exec(tpl)) {
					tpl = tpl.replace(match[0], data[match[1]]);
				}
				return tpl;
			}
			/* dom control */

			/* page fill */
			function getHtml(tpl, data) {
				var html = "";
				for (var i = 0; i < data.length; i++) {
					html += tplEngine(tpl, data[i]);
				}
				return html;
			}

			function popup(t) {
				var data = t.dataset;
				switch(data.type) {
					case "main":
						$popup_tip.innerHTML = "问题请在100字内描述完";
						$add_btn.onclick = function() {
							addMain();
						}
					break;
					case "scene":
						$popup_tip.innerHTML = "场景描述50字就够了";
						$add_btn.onclick = function() {
							addScene(data.aid, data.mid);
						}
					break;
					case "action":
						$popup_tip.innerHTML = "10字以内";
						$add_btn.onclick = function() {
							addAction(data.id);
						}
					break;
				}
				$popup_len.innerHTML = "已输入0字";
				$popup.style.display = "block";
			}
			$popup.addEventListener("click", function(e) {
				(/popup/.test(e.target.className)) && (this.style.display = "none");
			});
			$add.onkeyup = function() {
				$popup_len.innerHTML = "已输入" + $add.value.length + "字";
			}

			/* main */
			function getMainPage() {
				ajax("data/main.php", "", function(data) {
					path.cur = 0;
					if(data) {
						var main_tpl = document.querySelector('#main-tpl').innerHTML;
						var add_main_tpl = document.querySelector('#add-main-tpl').innerHTML;
						$page.innerHTML = getHtml(main_tpl, data) + add_main_tpl;
					} else {
						var add_main_tpl = document.querySelector('#add-main-tpl').innerHTML;
						$page.innerHTML = add_main_tpl;
					}
				});
			}

			function addMain() {
				var cont = $add.value;
				if(cont.length > 100) {
					alert("超过100字了，精简一下吧");
					return;
				}
				var data = 'cont=' + cont;
				ajax("data/main.php", data, function(data) {
					if(data == 1) {
						getMainPage();
						$add.value = "";
						$popup.style.display = "none";
					}else{
						alert("添加失败");
					}
				});
			}
			/* main */

			/* scene */
			function getScene(aid, mid, cont, sid) {
				var post_data = "aid=" + aid + "&mid=" + mid;
				var add_data = [{'aid': aid, 'mid': mid}];
				ajax("data/scene.php", post_data, function(data) {
					setTrace(aid, mid, sid, cont);
					if(data) {
						var scene_tpl = document.querySelector('#scene-tpl').innerHTML;
						var add_scene_tpl = document.querySelector('#add-scene-tpl').innerHTML;
						$page.innerHTML = getHtml(scene_tpl, data) + getHtml(add_scene_tpl, add_data);
					} else {
						var add_scene_tpl = document.querySelector('#add-scene-tpl').innerHTML;
						$page.innerHTML = "<p>目前没有场景</p>" + getHtml(add_scene_tpl, add_data);
					}
				});
			}

			var _user = 0;
			function addScene(aid, mid) {
				/*if(!_user) {
					_user = prompt("随便输个id用来记录，后续添加登录功能","name");
					if( !_user || _user == "name") {
						alert("随便打几个字符就好");
						return;
					}
				}*/
				var cont = $add.value;
				if(cont.length > 50) {
					alert("超过50字了，精简一下吧");
					return;
				}
				var post_data = 'aid=' + aid + '&mid=' + mid + '&cont=' + cont + '&uid=' + _user;
				ajax("data/scene.php", post_data, function(data) {
					if(data == 1) {
						var post_data = "aid=" + aid + "&mid=" + mid;
						var add_data = [{'aid': aid, 'mid': mid}];
						ajax("data/scene.php", post_data, function(data) {
							if(data) {
								var scene_tpl = document.querySelector('#scene-tpl').innerHTML;
								var add_scene_tpl = document.querySelector('#add-scene-tpl').innerHTML;
								$page.innerHTML = getHtml(scene_tpl, data) + getHtml(add_scene_tpl, add_data);
							} else {
								var add_scene_tpl = document.querySelector('#add-scene-tpl').innerHTML;
								$page.innerHTML = "<p>目前没有场景</p>" + getHtml(add_scene_tpl, add_data);
							}
						});
						$add.value = "";
						$popup.style.display = "none";
					}else{
						alert("添加失败");
					}
				});
			}
			/* scene */

			/* action */
			function getAction(sid, cont) {
				var add_data = [{'id': sid}];
				ajax("data/action.php", "id=" + sid, function(data) {
					if(data) {
						var action_tpl = document.querySelector('#action-tpl').innerHTML;
						var add_action_tpl = document.querySelector('#add-action-tpl').innerHTML;
						var $action = document.querySelector("#s" + sid);
						$action.innerHTML = getHtml(action_tpl, data) + getHtml(add_action_tpl, add_data);
					} else {
						var add_action_tpl = document.querySelector('#add-action-tpl').innerHTML;
						var $action = document.querySelector("#s" + sid);
						$action.innerHTML = getHtml(add_action_tpl, add_data);
					}
				});
			}

			function addAction(id) {
				/*if(!_user) {
					_user = prompt("随便输个id用来记录，后续添加登录功能","name");
					if( !_user || _user == "name") {
						alert("随便打几个字符就好");
						return;
					}
				}*/
				var cont = $add.value;
				if(cont.length > 10) {
					alert("超过10字了，精简一下吧");
					return;
				}
				var data = 'id=' + id + '&cont=' + cont + '&uid=' + _user;
				ajax("data/action.php", data, function(data) {
					if(data == 1) {
						getAction(id, cont);
						$add.value = "";
						$popup.style.display = "none";
					}else{
						alert("添加失败");
					}
				});
			}
			/* action */

			/**** trace ****/
			var path = {
				"trace": [],
				"cur": 0
			}

			function setTrace(aid, mid, sid, cont) {
				path.trace[path.cur] = {};
				path.trace[path.cur].mid = mid;
				path.trace[path.cur].sid = sid;
				path.trace[path.cur].aid = aid;
				path.trace[path.cur].cont = cont;
				path.cur++;


				var new_trace = [];
				var hash;
				for (var i = 0; i < path.cur; i++) {
					if(i == 0) {
						hash = "m" + path.trace[i].mid;
					} else {
						hash += "s" + path.trace[i].sid + "_" + path.trace[i].aid;
					}
					new_trace[i] = path.trace[i];
					new_trace[i].pos = i;
					if(i == path.cur - 1) {
						new_trace[i].active = " active";
					} else {
						new_trace[i].active = "";
					}
				}
				var trace_tpl = document.querySelector('#trace-tpl').innerHTML;
				document.querySelector(".trace").innerHTML = getHtml(trace_tpl, new_trace);

				window.location.hash = hash;
			}
			function getTrace(aid, mid, cur) {
				cur = cur || 0;
				path.cur = cur + 1;

				var post_data = "aid=" + aid + "&mid=" + mid;
				var add_data = [{'aid': aid, 'mid': mid}];

				ajax("data/scene.php", post_data, function(data) {

					var hash;
					for (var i = 0; i < path.cur; i++) {
						if(i == 0) {
							hash = "m" + path.trace[i].mid;
						} else {
							hash += "s" + path.trace[i].sid + "_" + path.trace[i].aid;
						}
					}
					window.location.hash = hash;

					document.querySelector(".trace .active").className = "box";
					document.querySelectorAll(".trace .box")[cur].className = "box active";

					if(data) {
						var scene_tpl = document.querySelector('#scene-tpl').innerHTML;
						var add_scene_tpl = document.querySelector('#add-scene-tpl').innerHTML;
						$page.innerHTML = getHtml(scene_tpl, data) + getHtml(add_scene_tpl, add_data);
					} else {
						var add_scene_tpl = document.querySelector('#add-scene-tpl').innerHTML;
						$page.innerHTML = "<p>目前没有场景</p>" + getHtml(add_scene_tpl, add_data);
					}
				});
			}

			/**** advance ****/
			document.querySelector(".expand").onclick = function() {
				if(document.body.className == "ex") {
					document.body.className = "";
				} else {
					document.body.className = "ex";
				}
			}
			/**** advance ****/

			/* start */
			if(/#m/.test(window.location.hash)) {
				getRecord();
			}

			function getRecord() {
				var post_data = "hash=" + window.location.hash;
				ajax("data/trace.php", post_data, function(data) {
					path.trace = [];
					path.cur = data.length;
					for (var i = 0; i < path.cur; i++) {
						path.trace[i] = data[i];
						path.trace[i].pos = i;
						if(i == path.cur - 1) {
							path.trace[i].active = " active";
						} else {
							path.trace[i].active = "";
						}
					}

					var trace_tpl = document.querySelector('#trace-tpl').innerHTML;
					document.querySelector(".trace").innerHTML = getHtml(trace_tpl, path.trace);
				});
			}
			/*var mark = window.location.hash.replace(/#s/,"").split("_");
			for (var i = 0; i < mark.length; i++) {
			}
			var hash = window.location.hash.split("s");
			var m = hash[0];
			var req = {}
			if(/#m\d+/.test(m)) {
				req.mid = m.match(/#m(\d+)/)[1];
				hash = hash.slice(1);
			}
			req.scene = [];
			for (var i = 0; i < hash.length; i++) {
				if(/(\d+)_(\d+)/.test(hash[i])) {
					var trace = hash[i].match(/(\d+)_(\d+)/);
					req.scene[i] = {}
					req.scene[i].sid = trace[1];
					req.scene[i].aid = trace[2];
				}
			}*/

			getMainPage();
			/* start */

		</script>
	</body>
</html>