<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>链式反应</title>
		<meta name ="keywords" content="Sign,ccx01,sign,the day of sign,signXday,沙因,游戏,银河,宇宙,时间,链式反应">
		<meta name="description" content="链式反应,计划通,链式问答具象化">
		<style>
			.node {
				overflow: hidden;
				margin: 20px 10px;
				padding: 10px;
				border: 1px solid #ccc;
				border-radius: 4px;
				box-shadow: 0 3px 1px #ccc;
				cursor: pointer;
			}
			.node .action {
				overflow: hidden;
				float: left;
			}
			.node .action .option,
			.node .add {
				float: left;
				border: 1px solid #eee;
				padding: 10px;
				border-radius: 4px;
				margin: 10px 10px 0 0;
			}
			.add {
				display: inline-block;
				border-radius: 5px;
				margin: 20px 10px;
				padding: 10px;
				border: 1px solid #ccc;
				border-radius: 4px;
				cursor: pointer;
			}
			.add span {
				display: inline-block;
				border: 1px solid #aaa;
				padding: 5px;
				box-shadow: 1px 1px 1px #ccc;
			}
			.trace {
				position: fixed;
				top: 0;
				left: 0;
				width: 20%;
				height: 100%;
				padding: 0;
				margin: 0;
				background: #363636;
			}
			.trace b {
				display: none;
			}
			.page {
				position: absolute;
				top: 0;
				left: 22%;
				width: 75%;
			}
			.tpl {
				display: none;
			}
			.box {
				padding: 10px;
				border: 1px solid #ccc;
				border-radius: 5px;
				margin: 20px 10px;
				background: #fefefe;
				box-shadow: 0 5px 1px #999;
				cursor: pointer;
			}
			@media screen and (max-width: 640px){
				.trace span {
					display: none;
				}
				.trace b {
					display: block;
				}
			}
		</style>
	</head>
	<body>
		<ul class="trace">
			<li class="box" onclick="getTrace(0,0,0)"><b>0</b><span>首页</span></li>
		</ul>
		<div class="page"></div>
		<!-- id cont tag time -->
		<template id="main-tpl" class="tpl">
			<div class="node" data-time="{#time}" data-json="">
				<div class="main" data-mid="{#id}" data-aid="0">{#cont}</div>
			</div>
		</template>
		<template id="add-main-tpl" class="tpl">
			<div class="add add-main">
				<input id="add-main" type="text">
				<span onclick='addMain()'>添加主干</span>
			</div>
		</template>
		<!-- id mid aid cont time -->
		<template id="scene-tpl" class="tpl">
			<div class="node" data-time="{#time}">
				<div class="scene" data-aid="{#id}" data-mid="0">{#cont}</div>
				<div id="s{#id}" class="action"></div>
			</div>
		</template>
		<template id="add-scene-tpl" class="tpl">
			<div class="add add-scene">
				<input id="add-scene{#mid}" type="text">
				<span onclick='addScene({#aid}, {#mid})'>添加场景</span>
			</div>
		</template>
		<!-- id sid cont time -->
		<template id="action-tpl" class="tpl">
			<span id="a{#id}" class="option" data-aid="{#id}">{#cont}</span>
		</template>
		<template id="add-action-tpl" class="tpl">
			<div class="add">
				<input id="add-action{#id}" type="text">
				<span onclick='addAction({#id})'>添加行为</span>
			</div>
		</template>
		<template id="trace-tpl" class="tpl">
			<li class="box" onclick="getTrace({#aid},{#mid},{#cur})"><b>{#cur}</b><span>{#cont}</span></li>
		</template>
		<!-- template -->
		<script>
			/* ajax */
			function ajax(url, data, callback) {
				var xmlhttp = new XMLHttpRequest();
					xmlhttp.open("POST", url, true);
					xmlhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
					xmlhttp.send(data);
					callback = callback || function() {};
				xmlhttp.onreadystatechange = function() {
					if(xmlhttp.readyState == 4 && xmlhttp.status == 200) {
						callback(JSON.parse(xmlhttp.responseText));
					}
				}
			}
			/* ajax */

			/* dom control */
			document.querySelector(".page").addEventListener("click", getPage);
			function getPage(e) {
				var t = e.target;
				switch(t.className) {
					case "main":
						getScene(t.dataset.aid, t.dataset.mid, t.innerHTML);
					break;
					case "option":
						getScene(t.dataset.aid, t.dataset.mid, t.parentNode.previousSibling.previousSibling.innerHTML + "(" + t.innerHTML + ")");
					break;
					case "scene":
						getAction(t.dataset.aid, t.innerHTML);
					break;
				}
			}

			HTMLElement.prototype.appendNodes = function(nodes) {
				var fragment = document.createDocumentFragment();
				for(var i = 0; i < nodes.length; i++) {
					fragment.appendChild(nodes[i].cloneNode(true));
				}
				this.appendChild(fragment);
			}
			function genNode(html) {
				var div_tmp = document.createElement("div");
					div_tmp.innerHTML = html;
				var nodes = div_tmp.childNodes; 
				return nodes;
			}
			function tplEngine(tpl, data) {
				var re = /{#(\w+)?}/;
				while (match = re.exec(tpl)) {
					tpl = tpl.replace(match[0], data[match[1]]);
				}
				return tpl;
			}
			/* dom control */

			/* page fill */
			var $page = document.querySelector(".page");
			function getHtml(tpl, data) {
				var html = "";
				for (var i = 0; i < data.length; i++) {
					html += tplEngine(tpl, data[i]);
				}
				return html;
			}

			/* main */
			function getMainPage() {
				ajax("data/main.php", "", function(data) {
					if(data) {
						var main_tpl = document.querySelector('#main-tpl').innerHTML;
						var add_main_tpl = document.querySelector('#add-main-tpl').innerHTML;
						$page.innerHTML = getHtml(main_tpl, data) + add_main_tpl;
					} else {
						var add_main_tpl = document.querySelector('#add-main-tpl').innerHTML;
						$page.innerHTML = add_main_tpl;
					}
				});
			}

			function addMain() {
				var cont = document.querySelector("#add-main").value;
				var data = 'cont=' + cont;
				ajax("data/main.php", data, function(data) {
					if(data == 1) {
						getMainPage();
					}else{
						alert("添加失败");
					}
				});
			}
			/* main */

			/* scene */
			var _mid = 0;	// setting _mid just make easy to search, event bind will solve it
			function getScene(aid, mid, cont, untrace) {
				var aid = aid || 0;
				var mid = mid || 0;
				_mid = mid || _mid;
				var data = "aid=" + aid + "&mid=" + _mid;
				var add_data = [{'aid': aid, 'mid': _mid}];
				ajax("data/scene.php", data, function(data) {
					// for search function
					/* useless for the moment */
					// window.location.hash = "m" + _mid + "a" + aid;

					if(!untrace) {
						/* trace */
						cur_trace++;
						trace[cur_trace] = {
							'aid': aid,
							'mid': mid,
							'cont': cont,
							'cur': cur_trace
						}
						var new_trace = [];
						for (var i = 0; i <= cur_trace; i++) {
							new_trace[i] = trace[i];
						}
						var trace_tpl = document.querySelector('#trace-tpl').innerHTML;
						document.querySelector(".trace").innerHTML = getHtml(trace_tpl, new_trace);
						/* trace */
					}

					if(data) {
						var scene_tpl = document.querySelector('#scene-tpl').innerHTML;
						var add_scene_tpl = document.querySelector('#add-scene-tpl').innerHTML;
						$page.innerHTML = getHtml(scene_tpl, data) + getHtml(add_scene_tpl, add_data);
					} else {
						var add_scene_tpl = document.querySelector('#add-scene-tpl').innerHTML;
						$page.innerHTML = "<p>目前没有场景</p>" + getHtml(add_scene_tpl, add_data);
					}
				});
			}

			var _user;
			function addScene(aid, mid) {
				if(!_user) {
					_user = prompt("随便输个id用来记录，后续添加登录功能","name");
					if( !_user || _user == "name") {
						alert("随便打几个字符就好");
						return;
					}
				}
				var cont = document.querySelector("#add-scene" + mid).value;
				var data = 'aid=' + aid + '&mid=' + mid + '&cont=' + cont + '&uid=' + _user;
				ajax("data/scene.php", data, function(data) {
					if(data == 1) {
						getScene(aid, mid, cont, true);
					}else{
						alert("添加失败");
					}
				});
			}
			/* scene */

			/* action */
			function getAction(sid, cont) {
				var add_data = [{'id': sid}];
				ajax("data/action.php", "id=" + sid, function(data) {
					/* trace */

					/* trace */
					if(data) {
						var action_tpl = document.querySelector('#action-tpl').innerHTML;
						var add_action_tpl = document.querySelector('#add-action-tpl').innerHTML;
						var $action = document.querySelector("#s" + sid);
						$action.innerHTML = getHtml(action_tpl, data) + getHtml(add_action_tpl, add_data);
					} else {
						var add_action_tpl = document.querySelector('#add-action-tpl').innerHTML;
						var $action = document.querySelector("#s" + sid);
						$action.innerHTML = getHtml(add_action_tpl, add_data);
					}
				});
			}

			function addAction(id) {
				if(!_user) {
					_user = prompt("随便输个id用来记录，后续添加登录功能","name");
					if( !_user || _user == "name") {
						alert("随便打几个字符就好");
						return;
					}
				}
				var cont = document.querySelector("#add-action" + id).value;
				var data = 'id=' + id + '&cont=' + cont + '&uid=' + _user;
				ajax("data/action.php", data, function(data) {
					if(data == 1) {
						getAction(id, cont);
					}else{
						alert("添加失败");
					}
				});
			}
			/* action */

			var trace = [];
			var cur_trace = 0;
			trace[0] = {
				'aid': 0,
				'mid': 0,
				'cont': '首页',
				'cur': 0
			}
			function getTrace(aid, mid, cur) {
				cur_trace = cur;

				if(cur == 0) {
					getMainPage();
					return;
				}

				var aid = aid || 0;
				var mid = mid || 0;
				_mid = mid || _mid;
				var data = "aid=" + aid + "&mid=" + _mid;
				var add_data = [{'aid': aid, 'mid': _mid}];

				ajax("data/scene.php", data, function(data) {
					// for search function
					/* useless for the moment */
					// window.location.hash = "m" + _mid + "a" + aid;
					if(data) {
						var scene_tpl = document.querySelector('#scene-tpl').innerHTML;
						var add_scene_tpl = document.querySelector('#add-scene-tpl').innerHTML;
						$page.innerHTML = getHtml(scene_tpl, data) + getHtml(add_scene_tpl, add_data);
					} else {
						var add_scene_tpl = document.querySelector('#add-scene-tpl').innerHTML;
						$page.innerHTML = "<p>目前没有场景</p>" + getHtml(add_scene_tpl, add_data);
					}
				});
			}

			/* page fill */
			/* start */
			/* useless for the moment */
			/*var hash = window.location.hash.match(/#m(\d)a(\d)/);
			if(hash && hash[1] && hash[2]) {
				getScene(hash[2], hash[1]);
			} else {
				getMainPage();
			}*/
			getMainPage();
			/* start */

		</script>
	</body>
</html>